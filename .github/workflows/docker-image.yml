name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Git Semantic Version
      uses: paulhatch/semantic-version@v5.0.2
      with:
        major_pattern: "major:"
        mino_pattern: "feat:"
        format: "${major}.${minor}.${patch}-prereleases${increment}"
        id: version

    - name: Build and push Docker image
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags: yourdockerhubusername/laravel:latest

    - name: Deploy to production
      uses: appleboy/ssh-action@master
      with:
        host: yourserverip
        username: yourserverusername
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          docker pull yourdockerhubusername/laravel:latest
          docker stop laravel
          docker rm laravel
          docker run -d --name laravel -p 80:80 -v /path/to/your/project:/var/www/html yourdockerhubusername/laravel:latest
    - name: Build Docker image
        run: |
          docker build -t milord/ventanillau:0.0.1 .
          docker build -t milord/ventanillau:latest .

    - name: Docker push image
        run: |
          docker push milord/ventanillau:0.0.1
          docker push milord/ventanillau:latest